---
name: quality-loop
description: "code-reviewer ↔ code-maintainer 반복 루프. 등급이 B 이상이 될 때까지 최대 3회 리뷰-수정 사이클을 자동 실행합니다."
argument-hint: "[최대 반복 횟수 (기본: 3)]"
disable-model-invocation: true
---

코드 품질 반복 개선 루프를 실행합니다. 리뷰 → 수정 → 재리뷰를 등급 B 이상이 될 때까지 반복합니다.

## 설정
$ARGUMENTS
최대 반복 횟수: $ARGUMENTS가 숫자이면 해당 값 사용, 아니면 기본값 3

## 사전 조건 확인

1. Glob 도구로 `project/**/*` 확인 — project/ 디렉토리가 존재하고 파일이 있는지
2. Read 도구로 mvp_spec.md 존재 확인
3. 하나라도 없으면 "project/ 또는 mvp_spec.md가 없습니다. /build-phase를 먼저 실행하세요." 안내 후 중단

---

## 반복 루프 실행

현재 사이클 번호를 1부터 시작합니다.

### 사이클 N: 리뷰 단계

사용자에게 "사이클 N/[최대] 시작: 코드 리뷰 실행 중..." 안내

Task 도구를 사용하여 `code-reviewer` 에이전트에게 다음 작업을 위임하세요:

> project/ 코드를 mvp_spec.md 기준으로 리뷰하세요.
> OWASP 보안 감사, 성능 리뷰, 코드 품질 점검, 테스트 생성/실행을 수행하세요.
> 이전 code_review_report.md가 있으면 이전 리뷰 대비 regression check를 반드시 수행하세요.
> 결과를 code_review_report.md로 저장하세요.

리뷰 완료 후:
1. Read 도구로 code_review_report.md의 Executive Summary에서 등급과 건수 추출
2. 사용자에게 "사이클 N 리뷰 결과: 등급 [X], CRITICAL [N]건, WARNING [N]건" 보고

### 판정

**등급 A 또는 B**:
- 사용자에게 "품질 목표 달성! (등급 [X], 사이클 N에서 통과)" 안내
- 루프를 종료하고 완료 보고로 이동

**등급 C 이하 + 사이클이 아직 최대 미만**:
- 사용자에게 "품질 미달 (등급 [X]). 자동 수정 후 재리뷰합니다. (사이클 N/[최대])" 안내
- 수정 단계로 진행

**등급 C 이하 + 사이클이 최대에 도달**:
- 사용자에게 "최대 반복 횟수 도달 (사이클 [최대]). 현재 등급: [X]" 안내
- 남은 CRITICAL/WARNING 항목 목록을 code_review_report.md에서 추출하여 요약
- "수동 검토를 권장합니다." 안내
- 루프를 종료하고 완료 보고로 이동

### 사이클 N: 수정 단계

사용자에게 "사이클 N/[최대]: 코드 수정 실행 중..." 안내

Task 도구를 사용하여 `code-maintainer` 에이전트에게 다음 작업을 위임하세요:

> code_review_report.md를 읽고 P0(즉시 수정) + P1(1주 내) 항목을 수정하세요.
> 보안 이슈 최우선으로 수정하세요.
> 모든 수정에 테스트를 추가하세요.
> 빌드와 테스트가 통과하는지 확인하세요.
> 결과를 maintenance_report.md로 저장하세요.

수정 완료 후:
1. maintenance_report.md에서 수정 건수, 빌드/테스트 결과 확인
2. 사용자에게 "사이클 N 수정 완료: [N]건 수정, 빌드 [PASS/FAIL], 테스트 [N/N 통과]" 보고
3. 빌드가 FAIL이면 사용자에게 "빌드 실패. 루프를 중단합니다." 안내 후 루프 종료
4. 빌드 PASS면 사이클 번호를 +1 하고 다음 사이클의 리뷰 단계로 진행

---

## 완료 보고

루프 종료 후 사용자에게 전체 요약을 보고하세요:

- 총 사이클 수
- 최종 등급 (마지막 리뷰 기준)
- 사이클별 등급 변화 이력 (예: D → C → B)
- 총 수정 건수 (보안, 버그, 성능, 품질 각각)
- 최종 테스트 통과율
- 다음 단계 권장:
  - 등급 A/B: "devops-deployer로 배포 설정을 진행하세요."
  - 등급 C 이하: "수동 검토 후 추가 /quality-loop를 실행하세요."

## 중요 규칙
- 등급 A/B에 도달하면 즉시 루프를 종료하세요 (불필요한 반복 금지).
- 매 사이클마다 사용자에게 진행 상황을 보고하세요.
- 빌드 실패 시 즉시 루프를 중단하세요.
- code-reviewer의 regression check (Step 6.5)를 통해 이전 대비 개선 여부를 확인하세요.
